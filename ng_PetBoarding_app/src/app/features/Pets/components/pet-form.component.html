<form [formGroup]="petForm" (ngSubmit)="onSubmit()" novalidate class="pet-form">
  <!-- Section informations de base -->
  <div class="form-section">
    <h3 class="section-title">
      <mat-icon>pets</mat-icon>
      Informations de base
    </h3>

    <!-- Nom et Type -->
    <div class="form-row">
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Nom de l'animal *</mat-label>
        <input matInput formControlName="name" placeholder="Ex: Rex" autocomplete="off" />
        <mat-icon matSuffix>pets</mat-icon>
        @if (getFieldError('name')) {
          <mat-error>{{ getFieldError('name') }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Type d'animal *</mat-label>
        <mat-select formControlName="type">
          @for (type of petTypes; track type) {
            <mat-option [value]="type">
              {{ petTypeLabels[type] }}
            </mat-option>
          }
        </mat-select>
        <mat-icon matSuffix>category</mat-icon>
        @if (getFieldError('type')) {
          <mat-error>{{ getFieldError('type') }}</mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Race et Âge -->
    <div class="form-row">
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Race *</mat-label>
        <input matInput formControlName="breed" placeholder="Ex: Labrador" autocomplete="off" />
        <mat-icon matSuffix>info</mat-icon>
        @if (getFieldError('breed')) {
          <mat-error>{{ getFieldError('breed') }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Âge (années) *</mat-label>
        <input matInput type="number" formControlName="age" min="0" max="30" />
        <mat-icon matSuffix>cake</mat-icon>
        @if (getFieldError('age')) {
          <mat-error>{{ getFieldError('age') }}</mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Couleur et Sexe -->
    <div class="form-row">
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Couleur *</mat-label>
        <input matInput formControlName="color" placeholder="Ex: Marron et blanc" autocomplete="off" />
        <mat-icon matSuffix>palette</mat-icon>
        @if (getFieldError('color')) {
          <mat-error>{{ getFieldError('color') }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Sexe *</mat-label>
        <mat-select formControlName="gender">
          @for (gender of petGenders; track gender) {
            <mat-option [value]="gender">
              {{ petGenderLabels[gender] }}
            </mat-option>
          }
        </mat-select>
        <mat-icon matSuffix>wc</mat-icon>
        @if (getFieldError('gender')) {
          <mat-error>{{ getFieldError('gender') }}</mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Poids -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Poids (kg)</mat-label>
      <input matInput type="number" formControlName="weight" min="0" step="0.1" placeholder="Optionnel" />
      <mat-icon matSuffix>monitor_weight</mat-icon>
      @if (getFieldError('weight')) {
        <mat-error>{{ getFieldError('weight') }}</mat-error>
      }
    </mat-form-field>

    <!-- Animal stérilisé -->
    <div class="checkbox-field">
      <mat-checkbox formControlName="isNeutered">
        Animal stérilisé/castré
      </mat-checkbox>
    </div>
  </div>

  <!-- Section informations médicales -->
  <div class="form-section">
    <h3 class="section-title">
      <mat-icon>medical_services</mat-icon>
      Informations médicales
    </h3>

    <!-- Puce électronique -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Numéro de puce électronique</mat-label>
      <input matInput formControlName="microchipNumber" placeholder="Ex: 123456789012345" autocomplete="off" />
      <mat-icon matSuffix>memory</mat-icon>
      @if (getFieldError('microchipNumber')) {
        <mat-error>{{ getFieldError('microchipNumber') }}</mat-error>
      }
    </mat-form-field>

    <!-- Notes médicales -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Notes médicales</mat-label>
      <textarea
        matInput
        formControlName="medicalNotes"
        rows="3"
        placeholder="Allergies, traitements en cours, historique médical..."></textarea>
      <mat-icon matSuffix>health_and_safety</mat-icon>
      @if (getFieldError('medicalNotes')) {
        <mat-error>{{ getFieldError('medicalNotes') }}</mat-error>
      }
    </mat-form-field>

    <!-- Besoins spéciaux -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Besoins spéciaux</mat-label>
      <textarea
        matInput
        formControlName="specialNeeds"
        rows="3"
        placeholder="Régime alimentaire spécial, exercices particuliers, anxiété..."></textarea>
      <mat-icon matSuffix>star</mat-icon>
      @if (getFieldError('specialNeeds')) {
        <mat-error>{{ getFieldError('specialNeeds') }}</mat-error>
      }
    </mat-form-field>
  </div>

  <!-- Section contact d'urgence -->
  <div class="form-section" formGroupName="emergencyContact">
    <h3 class="section-title">
      <mat-icon>emergency</mat-icon>
      Contact d'urgence
    </h3>

    <div class="form-row">
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Nom du contact</mat-label>
        <input matInput formControlName="name" placeholder="Nom complet" autocomplete="name" />
        <mat-icon matSuffix>person</mat-icon>
        @if (getEmergencyContactError('name')) {
          <mat-error>{{ getEmergencyContactError('name') }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Téléphone</mat-label>
        <input matInput formControlName="phone" placeholder="06 12 34 56 78" autocomplete="tel" />
        <mat-icon matSuffix>phone</mat-icon>
        @if (getEmergencyContactError('phone')) {
          <mat-error>{{ getEmergencyContactError('phone') }}</mat-error>
        }
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Relation</mat-label>
      <input matInput formControlName="relationship" placeholder="Ex: Voisin, Ami, Famille..." autocomplete="off" />
      <mat-icon matSuffix>people</mat-icon>
      @if (getEmergencyContactError('relationship')) {
        <mat-error>{{ getEmergencyContactError('relationship') }}</mat-error>
      }
    </mat-form-field>
  </div>

  <!-- Section Vaccinations -->
  <div class="form-section">
    <h3 class="section-title">
      <mat-icon>vaccines</mat-icon>
      Vaccinations
    </h3>
    <app-vaccination-list
      [vaccinations]="vaccinations()"
      [canAdd]="true"
      [canEdit]="true"
      [canDelete]="true"
      (addVaccination)="onAddVaccination()"
      (editVaccination)="onEditVaccination($event)"
      (deleteVaccination)="onDeleteVaccination($event)" />
  </div>

  <!-- Boutons d'action -->
  <div class="form-actions">
    <button
      mat-stroked-button
      type="button"
      class="action-button cancel-button"
      (click)="onCancel()"
      [disabled]="isLoading">
      <mat-icon>arrow_back</mat-icon>
      Annuler
    </button>

    <button
      mat-raised-button
      type="submit"
      class="action-button submit-button"
      [disabled]="!petForm.valid || isLoading">
      @if (isLoading) {
        <mat-spinner diameter="20" class="inline-spinner"></mat-spinner>
      } @else {
        <mat-icon>save</mat-icon>
      }
      {{ isEditMode() ? 'Sauvegarder les modifications' : 'Ajouter l\'animal' }}
    </button>
  </div>
</form>

<!-- Overlay pour le formulaire de vaccination -->
@if (showVaccinationForm()) {
  <div class="vaccination-form-overlay" (click)="onVaccinationFormCancel()">
    <div class="vaccination-form-container" (click)="$event.stopPropagation()">
      <app-vaccination-form
        [vaccination]="editingVaccination()"
        [isLoading]="false"
        (formSubmit)="onVaccinationFormSubmit($event)"
        (formCancel)="onVaccinationFormCancel()" />
    </div>
  </div>
}